<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="icon" href="../Favicon.png" type="image/x-icon">
    <link rel="shortcut icon" href="../Favicon.png" type="image/x-icon">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clan Leaderboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        theme: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                        }
                    },
                    boxShadow: {
                        'card': '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)',
                        'elevated': '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&family=Roboto:wght@400;500&display=swap');
        
        body {
            font-family: 'Roboto', sans-serif;
        }
        
        h1, h2, h3 {
            font-family: 'Poppins', sans-serif;
        }
        
        .search-highlight {
            background-color: rgba(59, 130, 246, 0.3);
            border-radius: 4px;
        }
        
        .ranking-badge {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            font-weight: 600;
        }
        
        th:nth-child(2) {
            padding-left: 8px;
            padding-right: 8px;
        }
        
        .clan-name {
            margin-left: 0.5rem;
        }
        
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border-left-color: #3b82f6;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-200 to-gray-100 text-gray-800 min-h-screen">
    <header class="bg-gray-800 text-white px-10 py-5 flex justify-between items-center shadow-lg">
        <div class="logo">
            <h1 class="text-2xl font-bold">MEE69 - FR3D</h1>
        </div>
        <nav>
            <ul class="flex gap-5">
                <li><a href="../" class="hover:text-blue-400 transition">‚Üê Back to Clans</a></li>
            </ul>
        </nav>
    </header>

    <div class="container mx-auto px-4 py-12 max-w-5xl">
        <!-- Header with logo -->
        <div class="relative mb-10">
            <div class="absolute top-0 left-0 w-24 h-24 bg-blue-500 rounded-full opacity-20 blur-2xl"></div>
            <div class="absolute top-10 right-10 w-32 h-32 bg-blue-400 rounded-full opacity-10 blur-2xl"></div>
            
            <div class="text-center relative z-10">
                <h1 id="page-title" class="text-4xl font-bold text-gray-800 mb-4">Clan Leaderboard</h1>
                <div class="w-32 h-1 bg-blue-600 mx-auto rounded-full mb-6"></div>
                <p class="text-blue-700 font-medium">Real-time clan battle statistics</p>
            </div>
            
            <div id="error-message" class="mt-6 text-red-600 text-center mb-4 font-medium bg-red-50 py-3 px-4 rounded-lg shadow-md max-w-lg mx-auto hidden"></div>
            
            <!-- Loading Overlay -->
            <div id="loading-overlay" class="mt-6 flex flex-col items-center justify-center py-8 hidden">
                <div class="loading-spinner mb-4"></div>
                <p class="text-gray-600 font-medium">Loading clan data...</p>
            </div>
        </div>

        <!-- Main Content Wrapper -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Clan Info Card -->
            <div id="clan-info" class="bg-white rounded-2xl shadow-lg lg:col-span-1 border border-gray-300 overflow-hidden fade-in">
                <div class="bg-blue-600 py-4 px-6">
                    <h2 class="text-white font-bold text-lg">Clan Profile</h2>
                </div>
                <div class="p-6">
                    <div class="flex flex-col items-center text-center">
                        <div class="relative mb-6">
                            <div class="absolute inset-0 bg-blue-500 rounded-full animate-pulse opacity-70 blur-md"></div>
                            <img id="clan-icon" src="" alt="Clan Icon" class="w-32 h-32 rounded-full shadow-lg border-4 border-white object-cover relative z-10" onerror="this.src='https://via.placeholder.com/128'">
                        </div>
                        <h2 id="clan-name" class="text-2xl font-bold text-gray-800 mb-3">üè∞ Clan: </h2>
                        <p id="clan-desc" class="text-gray-600 mb-4 italic">Loading...</p>
                        <div class="grid grid-cols-2 gap-4 w-full mt-4">
                            <div class="bg-blue-50 rounded-lg p-3 border border-blue-200">
                                <p class="text-sm text-blue-600 font-medium">Total Points</p>
                                <p id="clan-points" class="text-xl font-bold text-blue-800">0</p>
                            </div>
                            <div class="bg-green-50 rounded-lg p-3 border border-green-200">
                                <p class="text-sm text-green-600 font-medium">Members</p>
                                <p id="clan-member-count" class="text-xl font-bold text-green-800">0</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Leaderboard Section -->
            <div class="bg-white rounded-2xl shadow-lg lg:col-span-2 border border-gray-300 overflow-hidden fade-in">
                <div class="bg-blue-600 py-4 px-6 flex flex-col md:flex-row justify-between items-center gap-4">
                    <div class="flex items-center gap-4">
                        <h2 class="text-white font-bold text-lg">Member Rankings</h2>
                        <span class="text-white/80 text-sm">Battle: <span id="battle-id" class="font-semibold">Current</span></span>
                    </div>

                    <!-- Search Box -->
                    <div class="relative w-full md:w-auto">
                        <input 
                            type="text" 
                            id="search-input" 
                            placeholder="Search members..." 
                            class="bg-blue-700 border border-blue-500/50 rounded-full py-2 px-4 pl-10 text-white placeholder-blue-300 focus:outline-none focus:ring-2 focus:ring-blue-400 w-full md:w-64"
                        >
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 absolute left-3 top-2.5 text-blue-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead class="bg-gray-100 border-b border-gray-300">
                            <tr>
                                <th class="py-4 px-6 text-left text-gray-700 font-semibold">Rank</th>
                                <th class="py-4 px-6 text-left text-gray-700 font-semibold">Member</th>
                                <th class="py-4 px-6 text-right text-gray-700 font-semibold">Points</th>
                            </tr>
                        </thead>
                        
                        <tbody id="leaderboard-body">
                            <!-- Content will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>

                <!-- No Results Message -->
                <div id="no-results" class="hidden py-8 text-center text-gray-500">
                    <p>No members found matching your search.</p>
                </div>
                
                <!-- Loading State -->
                <div id="members-loading" class="py-12 flex justify-center items-center hidden">
                    <div class="loading-spinner"></div>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="mt-12 text-center text-gray-500 text-sm">
            <p>¬© PS99 Clan Battle Leaderboard ‚Ä¢ Updated in real-time</p>
        </div>
    </div>

    <script>
        // Global variables to store member data
        let allMembers = [];
        let currentMembers = [];
        let usernameMap = {};
        let avatarCache = {};
        let clanLeaderUserId = null;
        
        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const clanName = urlParams.get('clan');
        const battleId = urlParams.get('battle') || 'battle1';
        
        // Update battle ID display
        if (battleId) {
            const battleNum = battleId.replace('battle', '');
            document.getElementById('battle-id').textContent = `Battle ${battleNum}`;
        }
        
        // Initialize page
        if (clanName) {
            document.getElementById('page-title').textContent = `${clanName} - Clan Leaderboard`;
            loadClanData();
        } else {
            showError('No clan name provided in the URL.');
        }
        
        // Show error message
        function showError(message) {
            const errorEl = document.getElementById('error-message');
            errorEl.textContent = message;
            errorEl.classList.remove('hidden');
        }
        
        // Show/hide loading
        function setLoading(isLoading) {
            const loadingOverlay = document.getElementById('loading-overlay');
            const membersLoading = document.getElementById('members-loading');
            
            if (isLoading) {
                loadingOverlay.classList.remove('hidden');
                membersLoading.classList.remove('hidden');
            } else {
                loadingOverlay.classList.add('hidden');
                membersLoading.classList.add('hidden');
            }
        }
        
        // Load clan data
        async function loadClanData() {
            setLoading(true);
            
            try {
                const response = await fetch(`https://biggamesapi.io/api/clan/${battleId}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data && data.data && data.data[clanName]) {
                    const clanData = data.data[clanName];
                    await processClanData(clanData);
                } else {
                    showError('No data available for this clan in the selected battle.');
                }
            } catch (error) {
                console.error('Error fetching clan data:', error);
                showError(`Error fetching clan data: ${error.message}`);
            } finally {
                setLoading(false);
            }
        }
        
        // Process clan data
        async function processClanData(clanData) {
            // Update clan info
            const clanIcon = document.getElementById('clan-icon');
            let iconUrl = clanData.Icon || '';
            if (iconUrl && iconUrl.includes('rbxassetid://')) {
                iconUrl = iconUrl.replace('rbxassetid://', 'https://biggamesapi.io/image/');
            } else if (!iconUrl) {
                iconUrl = 'https://via.placeholder.com/128';
            }
            clanIcon.src = iconUrl;
            
            document.getElementById('clan-name').textContent = `üè∞ ${clanName}`;
            
            // Get clan leader ID (the owner of the clan)
            clanLeaderUserId = clanData.Owner || null;
            
            // Process members
            const members = [];
            
            // Add clan leader with their points
            if (clanLeaderUserId) {
                members.push({
                    UserID: clanLeaderUserId,
                    Points: clanData.Points || 0,
                    isLeader: true
                });
            }
            
            // Add all other members
            if (clanData.Members && typeof clanData.Members === 'object') {
                Object.entries(clanData.Members).forEach(([userId, memberData]) => {
                    // Convert userId to number for consistency
                    const userIdNum = parseInt(userId);
                    if (!isNaN(userIdNum) && userIdNum !== clanLeaderUserId) {
                        members.push({
                            UserID: userIdNum,
                            Points: memberData.Points || 0,
                            isLeader: false
                        });
                    }
                });
            }
            
            // Sort members by points (descending)
            members.sort((a, b) => b.Points - a.Points);
            
            allMembers = members;
            currentMembers = [...allMembers];
            
            // Calculate total points
            const totalPoints = members.reduce((sum, member) => sum + member.Points, 0);
            document.getElementById('clan-points').textContent = totalPoints.toLocaleString();
            document.getElementById('clan-member-count').textContent = members.length;
            
            // Fetch usernames for all members
            const userIds = members.map(m => m.UserID);
            await fetchUsernamesFromRoblox(userIds);
            
            // Render initial leaderboard
            renderLeaderboard();
            
            // Fetch avatars in background (non-blocking)
            fetchAvatarsBatched(userIds);
        }
        
        // Fetch usernames from Roblox API
        async function fetchUsernamesFromRoblox(userIds) {
            if (!userIds || userIds.length === 0) {
                return;
            }

            const batchSize = 50;
            
            for (let i = 0; i < userIds.length; i += batchSize) {
                const batch = userIds.slice(i, i + batchSize);
                
                await Promise.all(batch.map(async (userId) => {
                    try {
                        // Try proxy first
                        let response = await fetch(`https://users.roproxy.com/v1/users/${userId}`);
                        
                        // Fallback to direct API if proxy fails
                        if (!response.ok) {
                            response = await fetch(`https://users.roblox.com/v1/users/${userId}`);
                        }
                        
                        if (!response.ok) {
                            console.warn(`Failed to fetch user ${userId}: ${response.status}`);
                            usernameMap[userId] = `User ${userId}`;
                            return;
                        }
                        
                        const data = await response.json();
                        usernameMap[userId] = data.name || `User ${userId}`;
                    } catch (e) {
                        console.error(`Error fetching username for ${userId}:`, e);
                        usernameMap[userId] = `User ${userId}`;
                    }
                }));
                
                // Small delay between batches
                if (i + batchSize < userIds.length) {
                    await new Promise(resolve => setTimeout(resolve, 150));
                }
            }
        }
        
        // Render leaderboard
        function renderLeaderboard() {
            const leaderboardBody = document.getElementById('leaderboard-body');
            const noResults = document.getElementById('no-results');
            
            if (currentMembers.length === 0) {
                leaderboardBody.innerHTML = '';
                noResults.classList.remove('hidden');
                return;
            }
            
            noResults.classList.add('hidden');
            
            let leaderboardHtml = '';
            
            currentMembers.forEach((member, index) => {
                const userId = member.UserID;
                const username = usernameMap[userId] || `User ${userId}`;
                const originalIndex = allMembers.findIndex(m => m.UserID === userId);
                const rank = originalIndex + 1;
                
                // Apply special styling for top 3 ranks
                let rowClass = 'border-b border-gray-200 hover:bg-gray-50 transition-colors';
                let rankBadge;
                
                if (originalIndex === 0) {
                    rowClass = 'border-b border-gray-200 bg-yellow-50 hover:bg-yellow-100 transition-colors';
                    rankBadge = `<div class="ranking-badge bg-yellow-500 text-white">1</div>`;
                } else if (originalIndex === 1) {
                    rowClass = 'border-b border-gray-200 bg-gray-100 hover:bg-gray-200 transition-colors';
                    rankBadge = `<div class="ranking-badge bg-gray-400 text-gray-900">2</div>`;
                } else if (originalIndex === 2) {
                    rowClass = 'border-b border-gray-200 bg-amber-50 hover:bg-amber-100 transition-colors';
                    rankBadge = `<div class="ranking-badge bg-amber-700 text-white">3</div>`;
                } else {
                    rankBadge = `<div class="text-gray-600 font-medium pl-2">${rank}</div>`;
                }
                
                // Get cached avatar or use placeholder
                const avatarUrl = avatarCache[userId] || 'https://via.placeholder.com/40';
                
                // Add leader badge if applicable
                const leaderBadge = member.isLeader ? '<span class="ml-2 px-2 py-1 bg-yellow-400 text-yellow-900 text-xs font-bold rounded-full">LEADER</span>' : '';
                
                leaderboardHtml += `
                    <tr id="user-row-${userId}" class="${rowClass}">
                        <td class="py-4 px-6 text-left">${rankBadge}</td>
                        <td class="py-4 px-6">
                            <div class="flex items-center">
                                <img src="${avatarUrl}" alt="Avatar" class="w-10 h-10 rounded-full border-2 border-gray-300 mr-4" id="avatar-${userId}" onerror="this.src='https://via.placeholder.com/40'">
                                <div class="flex items-center">
                                    <span class="font-semibold text-gray-800" id="name-${userId}">${username}</span>
                                    ${leaderBadge}
                                </div>
                            </div>
                        </td>
                        <td class="py-4 px-6 text-right font-bold text-blue-600">${member.Points.toLocaleString()}</td>
                    </tr>
                `;
            });

            leaderboardBody.innerHTML = leaderboardHtml;
        }
        
        // Fetch avatars in batches
        async function fetchAvatarsBatched(userIds) {
            if (!userIds || userIds.length === 0) return;
            
            const batchSize = 50; // Roblox API supports up to 100 but we use 50 for safety
            
            for (let i = 0; i < userIds.length; i += batchSize) {
                const batch = userIds.slice(i, i + batchSize);
                try {
                    const avatars = await fetchAvatarBatch(batch);
                    updateAvatarsInUI(avatars);
                    
                    // Small delay between batches
                    if (i + batchSize < userIds.length) {
                        await new Promise(resolve => setTimeout(resolve, 300));
                    }
                } catch (error) {
                    console.warn(`Error fetching avatars for batch ${i}:`, error);
                }
            }
        }
        
        // Fetch a batch of avatars
        async function fetchAvatarBatch(userIds) {
            try {
                // Try proxy first
                const proxyUrl = `https://thumbnails.roproxy.com/v1/users/avatar-headshot?userIds=${userIds.join(',')}&size=150x150&format=Png&isCircular=true`;
                let response = await fetch(proxyUrl);
                
                if (response.ok) {
                    const data = await response.json();
                    return data.data || [];
                }
                
                // Fallback to direct Roblox API
                const directUrl = `https://thumbnails.roblox.com/v1/users/avatar-headshot?userIds=${userIds.join(',')}&size=150x150&format=Png&isCircular=true`;
                response = await fetch(directUrl);
                
                if (response.ok) {
                    const data = await response.json();
                    return data.data || [];
                }
                
                return [];
            } catch (error) {
                console.error("Error fetching avatars:", error);
                return [];
            }
        }
        
        // Update avatars in the UI
        function updateAvatarsInUI(avatars) {
            if (!avatars || !Array.isArray(avatars)) return;
            
            avatars.forEach(avatar => {
                if (!avatar.targetId || !avatar.imageUrl) return;
                
                // Store in cache
                avatarCache[avatar.targetId] = avatar.imageUrl;
                
                // Update UI if element exists
                const imgElement = document.getElementById(`avatar-${avatar.targetId}`);
                if (imgElement) {
                    imgElement.src = avatar.imageUrl;
                }
            });
        }
        
        // Search functionality
        const searchInput = document.getElementById('search-input');
        let searchTimeout;
        
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            
            searchTimeout = setTimeout(() => {
                const searchTerm = this.value.trim().toLowerCase();
                
                if (searchTerm === '') {
                    currentMembers = [...allMembers];
                } else {
                    currentMembers = allMembers.filter(member => {
                        const username = (usernameMap[member.UserID] || '').toLowerCase();
                        const userId = String(member.UserID);
                        return username.includes(searchTerm) || userId.includes(searchTerm);
                    });
                }
                
                renderLeaderboard();
            }, 300);
        });
    </script>
</body>
</html>
